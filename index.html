<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Dynamic Lockscreen</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto+Mono:wght@500&family=Roboto:wght@400;500&family=Playfair+Display:wght@700&family=Source+Code+Pro:wght@700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; font-family: 'Roboto', sans-serif; }
        body { background-color: #1a1a1a; color: white; text-align: center; }
        #lock-screen { position: relative; width: 100vw; height: 100vh; background-image: url('https://images.pexels.com/photos/807598/pexels-photo-807598.jpeg'); background-size: cover; background-position: center center; overflow: hidden; transition: background-image 0.5s ease-in-out; text-align: left; --icon-stroke-color: white; }
        #lock-screen.panning-active { cursor: grab; } #lock-screen.panning-active:active { cursor: grabbing; }
        #status-bar { position: absolute; top: 20px; right: 30px; font-size: 1rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.6); z-index: 20; }
        #weather-info { display: flex; align-items: center; gap: 10px; user-select: none; padding: 10px 15px; border-radius: 12px; transition: background-color 0.2s; background-color: rgba(0, 0, 0, 0.2); }
        .draggable-item { position: absolute; user-select: none; cursor: grab; z-index: 10; } .draggable-item:active { cursor: grabbing; z-index: 11; }
        #clock { top: 30%; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Oswald', sans-serif; font-weight: 700; color: #fff; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); }
        #hours, #minutes { font-size: clamp(6rem, 15vw, 12rem); line-height: 0.8; pointer-events: none; } #minutes { margin-top: -1.5rem; }
        .app-icon { width: 70px; height: 70px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); transition: transform 0.2s ease; } .app-icon:active { transform: scale(1.1); }
        .app-icon svg { width: 100%; height: 100%; }
        #youtube-music-btn { top: 60%; left: calc(50% - 100px); } #youtube-btn { top: 60%; left: calc(50% + 30px); }
        #stock-widget { position: absolute; top: 75%; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.2); padding: 10px 15px; border-radius: 12px; color: white; font-family: 'Roboto', sans-serif; font-size: 1rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.6); display: flex; flex-direction: column; gap: 8px; min-width: 190px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .stock-row { display: flex; justify-content: space-between; align-items: center; }
        .stock-info { display: flex; align-items: center; gap: 10px; font-weight: 500; letter-spacing: 0.5px;}
        .stock-price { font-family: 'Roboto Mono', monospace; font-weight: 500; font-size: 1.1rem; }
        .stock-info .fa-caret-up { color: #2ecc71; } .stock-info .fa-caret-down { color: #e74c3c; }
        #settings-btn { top: 80%; left: 50px; }
        #settings-btn svg circle:nth-child(2) { stroke: var(--icon-stroke-color); }
        #settings-menu, #stock-editor-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        #settings-menu.visible, #stock-editor-menu.visible { display: flex; opacity: 1; }
        .menu-content { background-color: #2c2c2e; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; color: #f2f2f7; text-align: left; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.3s ease; }
        #settings-menu.visible .menu-content, #stock-editor-menu.visible .menu-content { transform: scale(1); }
        .menu-content h2 {text-align: center;}
        #close-settings-btn, #close-stock-editor-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #aaa; font-size: 2rem; cursor: pointer; line-height: 1; }
        #wallpaper-url-input, #stock-symbols-input, #weather-location-input, #font-select, #clock-color-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #555; background-color: #3a3a3c; color: white; font-size: 1rem; outline: none; }
        #clock-color-input { padding: 5px; height: 50px; }
        #stock-symbols-input { margin: 10px 0; text-transform: uppercase; text-align: center; }
        #save-stocks-btn, #qr-upload-btn, #reset-positions-btn { background-color: #0a84ff; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9em; margin-top: 10px; }
        #reset-positions-btn { background-color: #e74c3c; width: 100%; }
        .settings-section { margin-top: 25px; border-top: 1px solid #444; padding-top: 20px; }
        .settings-section:first-child { margin-top: 0; border-top: none; padding-top: 0; }
        .settings-section h3 { margin-bottom: 5px; text-align: center; } .settings-section h4 { margin-top: 15px; margin-bottom: 5px; color: #ccc; font-weight: 500; }
        .setting-toggle { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .settings-footer button { background: none; border: none; color: #aeb0b5; width: 100%; text-align: center; padding: 12px 0; font-size: 1em; font-weight: 500; display: flex; justify-content: center; align-items: center; gap: 10px; border-radius: 8px; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .settings-footer button:hover { background-color: rgba(255, 255, 255, 0.1); color: #fff; }
        #wallpaper-choices { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background-color: #1c1c1e; border-radius: 10px; }
        .wallpaper-thumbnail { position: relative; width: 100%; padding-bottom: 100%; background-size: cover; background-position: center; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s, transform 0.2s; }
        .wallpaper-thumbnail:hover { border-color: #0a84ff; transform: scale(1.05); }
        .remove-thumb-btn { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; line-height: 20px; font-family: sans-serif; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .wallpaper-thumbnail:hover .remove-thumb-btn { opacity: 1; }
        #fullscreen-hint { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.4); padding: 8px 15px; border-radius: 12px; color: #f0f0f0; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); opacity: 0; transition: opacity 1s ease-out; z-index: 25; pointer-events: none; }
        #unlock-prompt, #fullscreen-hint.visible { opacity: 1; }
        #unlock-prompt.visible { pointer-events: auto; }
        #unlock-prompt { position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); color: white; font-size: 1.3rem; font-weight: 500; text-shadow: 1px 1px 8px rgba(0,0,0,0.8); user-select: none; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.7s ease; z-index: 25; }
        .hidden { display: none !important; }
        #qr-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 1001; }
        #qr-modal-content { background: #fff; padding: 25px; border-radius: 16px; text-align: center; color: #333; }
        #qr-code { padding: 10px; background: white; margin-bottom: 15px; display: inline-block; } #qr-code img { display: block; margin: auto; }
        #upload-view { display: none; justify-content: center; align-items: center; width: 100%; height: 100%; padding: 20px; }
        #phone-upload-container { display: flex; flex-direction: column; width: 90%; max-width: 400px; gap: 10px; text-align: center; }
        #phone-upload-container h2 { color: #f2f2f7; }
        #phone-upload-container p { color: #aeb0b5; font-size: 0.9rem; margin: 0; }
        #phone-url-input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #555; background-color: #3a3a3c; color: white; font-size: 1rem; outline: none; }
        #phone-url-submit { background-color: #0a84ff; color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-weight: 500; }
        #phone-url-submit:disabled { background-color: #555; cursor: not-allowed; }
        #upload-label { display: inline-block; background-color: #34c759; color: white; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; font-weight: 500; }
        .separator-text { margin: 5px 0; font-style: italic; color: #888; }
        .fun-mode-toggle { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; font-family: 'Roboto', sans-serif; }
        #fun-mode-checkbox { width: 20px; height: 20px; }
        .flash-overlay { position: fixed; left: 0; width: 100%; height: 20%; z-index: 9999; pointer-events: none; opacity: 0; }
        #flash-top { top: 0; background: radial-gradient(ellipse at top, rgba(46, 204, 113, 0.4) 0%, rgba(46, 204, 113, 0) 70%); }
        #flash-bottom { bottom: 0; background: radial-gradient(ellipse at bottom, rgba(231, 76, 60, 0.4) 0%, rgba(231, 76, 60, 0) 70%); }
        .flash-active { animation: flash-in-out 1.5s ease-out; }
        @keyframes flash-in-out { 0% { opacity: 0; } 20% { opacity: 1; } 100% { opacity: 0; } }
        .raining-icon { position: fixed; top: -50px; font-size: 2rem; z-index: 9998; pointer-events: none; opacity: 0.7; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .raining-icon.up { color: #2ecc71; animation-name: rise-anim; }
        .raining-icon.down { color: #e74c3c; animation-name: fall-anim; }
        @keyframes fall-anim { from { transform: translateY(-10vh) rotate(0deg); opacity: 1; } to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        @keyframes rise-anim { from { transform: translateY(110vh) rotate(0deg); opacity: 1; } to { transform: translateY(-10vh) rotate(720deg); opacity: 0; } }
        
        /* Light Theme Rules */
        #lock-screen.light-theme { --icon-stroke-color: #333; }
        #lock-screen.light-theme #clock { color: #333; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));}
        #lock-screen.light-theme #status-bar, #lock-screen.light-theme #stock-widget, #lock-screen.light-theme #unlock-prompt, #lock-screen.light-theme #fullscreen-hint {
            color: #333;
            text-shadow: 1px 1px 3px rgba(255,255,255,0.4);
        }
        #lock-screen.light-theme #weather-info, #lock-screen.light-theme #stock-widget {
             background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="lock-screen">
        <div id="status-bar"><div id="weather-info"><span id="date"></span> <i id="weather-icon" class="fa-solid fa-cloud-sun"></i> <span id="temperature">...</span></div></div>
        <div id="fullscreen-hint">Double press wallpaper for fullscreen</div>
        <div id="clock" class="draggable-item"><div id="hours">00</div><div id="minutes">00</div></div>
        <div id="youtube-music-btn" class="draggable-item app-icon"><a href="https://music.youtube.com/" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FF0000"/><circle cx="50" cy="50" r="23" fill="none" stroke="white" stroke-width="4"/><polygon points="43,38 62,50 43,62" fill="white"/></svg></a></div>
        <div id="youtube-btn" class="draggable-item app-icon"><a href="https://www.youtube.com/" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#FF0000"/><path d="M 35,29 A 10,10 0 0 0 25,39 V 61 A 10,10 0 0 0 35,71 H 65 A 10,10 0 0 0 75,61 V 39 A 10,10 0 0 0 65,29 Z" fill="white"/><polygon points="45,42 62,50 45,58" fill="#FF0000"/></svg></a></div>
        <div id="stock-widget" class="draggable-item" title="Double-click to edit stocks"></div>
        <div id="settings-btn" class="draggable-item app-icon" title="Open wallpaper menu"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="7.5" fill="rgba(80, 80, 80, 0.6)"/><circle cx="8" cy="8" r="4" fill="none" stroke="var(--icon-stroke-color)" stroke-width="1.5"/></svg></div>
        <div id="unlock-prompt">Press to unlock</div>
    </div>
    <div id="settings-menu">
        <div class="menu-content">
            <button id="close-settings-btn">×</button>
            <h2 id="settings-title">Wallpapers</h2>
            <div id="advanced-settings-view" class="hidden">
                <div class="settings-section">
                    <h3>Theme & Style</h3>
                    <div class="setting-toggle">
                        <label for="theme-toggle">Light Theme</label>
                        <input type="checkbox" id="theme-toggle">
                    </div>
                    <label for="clock-color-input">Clock Color</label>
                    <input type="color" id="clock-color-input" value="#ffffff">
                    <label for="font-select">Clock Font</label>
                    <select id="font-select">
                        <option value="'Oswald', sans-serif">Oswald (Default)</option>
                        <option value="'Playfair Display', serif">Playfair Display</option>
                        <option value="'Source Code Pro', monospace">Source Code Pro</option>
                    </select>
                </div>
                <div class="settings-section">
                    <h3>Weather Location</h3>
                    <p>Enter a city name or leave blank for auto-detection.</p>
                    <input type="text" id="weather-location-input" placeholder="e.g., London">
                </div>
            </div>
            <div class="settings-section">
                <h3>Wallpaper</h3>
                <p>Paste an image URL below or add from phone.</p>
                <input type="text" id="wallpaper-url-input" placeholder="https://example.com/image.jpg">
                <button id="qr-upload-btn">Add from Phone</button>
                <h4>Your Wallpapers</h4>
                <div id="wallpaper-choices"></div>
            </div>
            <div id="advanced-settings-footer" class="hidden">
                <div class="settings-section">
                    <button id="reset-positions-btn">Reset All Positions</button>
                </div>
            </div>
            <div class="settings-section settings-footer" id="settings-footer">
                <button id="show-advanced-settings-btn"><i class="fa-solid fa-sliders"></i> Show Full Settings</button>
                <button id="hide-advanced-settings-btn" class="hidden"><i class="fa-solid fa-arrow-left"></i> Back to Wallpapers</button>
            </div>
        </div>
    </div>
    <div id="stock-editor-menu"><div class="menu-content"><button id="close-stock-editor-btn">×</button><h2>Edit Stock Symbols</h2><p>Enter up to 7 stock symbols, separated by commas.</p><input type="text" id="stock-symbols-input" placeholder="TSLA, GOOGL, AKBA..."><div class="fun-mode-toggle"><label for="fun-mode-checkbox">Fun Mode 🎉</label><input type="checkbox" id="fun-mode-checkbox"></div><button id="save-stocks-btn">Save and Update</button></div></div>
    <div id="qr-modal"><div id="qr-modal-content"><h2>Scan with your phone</h2><div id="qr-code"></div><p>Scan to send an image URL from your phone.</p></div></div>
    <div id="upload-view"><div id="phone-upload-container"><h2>Add Wallpaper from Phone</h2><label for="file-input" id="upload-label">Tap to Upload Image</label><input type="file" id="file-input" accept="image/*" style="display: none;"><p class="separator-text">... or ...</p><p>Paste an image URL below</p><input type="url" id="phone-url-input" placeholder="https://example.com/image.jpg"><button id="phone-url-submit">Use this URL</button><h2 id="upload-status"></h2></div></div>
    <div id="flash-top" class="flash-overlay"></div>
    <div id="flash-bottom" class="flash-overlay"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const NPOINT_BIN_ID = 'f76d79c771a62c1ce33a';
            const lockScreen = document.getElementById('lock-screen');
            const clock = document.getElementById('clock');
            const qrModal = document.getElementById('qr-modal');
            const initialWallpaper = { url: 'https://images.pexels.com/photos/807598/pexels-photo-807598.jpeg', position: 'center center' };
            let isPanningMode = false, currentWallpaperImg = new Image(), pollingInterval, clickTimer, inactivityTimer, pressHoldTimer;
            let hasMovedWp = false;

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('upload') && urlParams.has('session')) {
                document.body.style.backgroundColor = '#1a1a1a';
                ['lock-screen', 'settings-menu', 'stock-editor-menu', 'qr-modal'].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
                document.getElementById('upload-view').style.display = 'flex';
                handlePhoneUpload(urlParams.get('session'));
            } else {
                initializeLockscreen();
            }

            function handlePhoneUpload(session) {
                const IMGBB_API_KEY = '4418969a1a33c4e2ea690d835d915e52';
                const fileInput = document.getElementById('file-input');
                const urlInput = document.getElementById('phone-url-input');
                const urlSubmitBtn = document.getElementById('phone-url-submit');
                const statusElem = document.getElementById('upload-status');
                const uploadLabel = document.getElementById('upload-label');
                const sendUrlToLockscreen = (imageUrl) => {
                    statusElem.textContent = 'Sending to PC...';
                    fileInput.disabled = true; urlInput.disabled = true; urlSubmitBtn.disabled = true;
                    uploadLabel.style.backgroundColor = '#555';
                    fetch(`https://api.npoint.io/${NPOINT_BIN_ID}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ [session]: imageUrl }) })
                    .then(r => { if (!r.ok) throw new Error('Failed to update PC.'); statusElem.textContent = 'Success! You can close this window.'; })
                    .catch(e => { statusElem.textContent = `Error: ${e.message}`; fileInput.disabled = false; urlInput.disabled = false; urlSubmitBtn.disabled = false; uploadLabel.style.backgroundColor = '#34c759'; });
                };
                fileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; statusElem.textContent = 'Uploading to ImgBB...'; const formData = new FormData(); formData.append('key', IMGBB_API_KEY); formData.append('image', file); fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData }).then(response => response.json()).then(data => { if (data.success) { sendUrlToLockscreen(data.data.url); } else { throw new Error(data.error.message || 'ImgBB upload failed.'); } }).catch(error => { statusElem.textContent = `Error: ${error.message}`; }); });
                urlSubmitBtn.addEventListener('click', () => { const imageUrl = urlInput.value.trim(); if (!imageUrl || !imageUrl.startsWith('http')) { statusElem.textContent = 'Please enter a valid image URL.'; return; } sendUrlToLockscreen(imageUrl); });
            }

            function initializeLockscreen() {
                const settingsMenu = document.getElementById('settings-menu');
                const closeSettingsBtn = document.getElementById('close-settings-btn');
                const fullscreenHint = document.getElementById('fullscreen-hint');
                const unlockPrompt = document.getElementById('unlock-prompt');
                
                const advancedSettingsView = document.getElementById('advanced-settings-view');
                const advancedSettingsFooter = document.getElementById('advanced-settings-footer');
                const showAdvancedBtn = document.getElementById('show-advanced-settings-btn');
                const hideAdvancedBtn = document.getElementById('hide-advanced-settings-btn');
                const settingsTitle = document.getElementById('settings-title');

                const showFullSettings = () => { advancedSettingsView.classList.remove('hidden'); advancedSettingsFooter.classList.remove('hidden'); showAdvancedBtn.classList.add('hidden'); hideAdvancedBtn.classList.remove('hidden'); settingsTitle.textContent = 'Full Settings'; };
                const showWallpaperSettings = () => { advancedSettingsView.classList.add('hidden'); advancedSettingsFooter.classList.add('hidden'); showAdvancedBtn.classList.remove('hidden'); hideAdvancedBtn.classList.add('hidden'); settingsTitle.textContent = 'Wallpapers'; };

                showAdvancedBtn.addEventListener('click', showFullSettings);
                hideAdvancedBtn.addEventListener('click', showWallpaperSettings);

                closeSettingsBtn.addEventListener('click', () => settingsMenu.classList.remove('visible'));
                settingsMenu.addEventListener('click', (e) => { if (e.target === settingsMenu) settingsMenu.classList.remove('visible'); });

                const FINNHUB_API_KEY = 'd1obuihr01qtrav0d5sgd1obuihr01qtrav0d5t0';
                
                const stockWidget = document.getElementById('stock-widget');
                const stockEditorMenu = document.getElementById('stock-editor-menu');
                const closeStockEditorBtn = document.getElementById('close-stock-editor-btn');
                const saveStocksBtn = document.getElementById('save-stocks-btn');
                const stockSymbolsInput = document.getElementById('stock-symbols-input');
                const funModeCheckbox = document.getElementById('fun-mode-checkbox');
                let lastKnownFirstStockPrice = null;

                const getStockSymbols = () => JSON.parse(localStorage.getItem('lockscreenStockSymbols')) || ['NIO'];
                const saveStockSymbols = (symbols) => localStorage.setItem('lockscreenStockSymbols', JSON.stringify(symbols));
                const getFunModeState = () => localStorage.getItem('lockscreenFunModeEnabled') === 'true';
                const saveFunModeState = (isEnabled) => localStorage.setItem('lockscreenFunModeEnabled', isEnabled);
                
                funModeCheckbox.checked = getFunModeState();
                funModeCheckbox.addEventListener('change', () => saveFunModeState(funModeCheckbox.checked));

                function triggerScreenFlash(isUp) { const flashEl = isUp ? document.getElementById('flash-top') : document.getElementById('flash-bottom'); flashEl.classList.add('flash-active'); setTimeout(() => flashEl.classList.remove('flash-active'), 1500); }
                function triggerIconShower(isUp) { for (let i = 0; i < 20; i++) { const icon = document.createElement('i'); icon.className = `fa-solid raining-icon ${isUp ? 'fa-caret-up up' : 'fa-caret-down down'}`; icon.style.left = `${Math.random() * 100}vw`; icon.style.animationDuration = `${(Math.random() * 2) + 3}s`; icon.style.animationDelay = `${Math.random() * 2}s`; icon.style.transform = `scale(${(Math.random() * 0.5) + 0.8})`; icon.addEventListener('animationend', () => icon.remove()); document.body.appendChild(icon); } }
                
                function checkFunModeTrigger() {
                    if (!getFunModeState()) return;
                    const firstStock = getStockSymbols()[0];
                    if (!firstStock) return;
                    fetch(`https://finnhub.io/api/v1/quote?symbol=${firstStock}&token=${FINNHUB_API_KEY}`)
                        .then(r => r.json()).then(data => {
                            if (!data || typeof data.c === 'undefined') return;
                            const currentPrice = data.c;
                            if (lastKnownFirstStockPrice !== null && lastKnownFirstStockPrice !== currentPrice) {
                                if (currentPrice > lastKnownFirstStockPrice) { triggerScreenFlash(true); triggerIconShower(true); } 
                                else { triggerScreenFlash(false); triggerIconShower(false); }
                            }
                            lastKnownFirstStockPrice = currentPrice;
                        });
                }

                function updateStockWidget() {
                    const symbols = getStockSymbols();
                    stockWidget.innerHTML = '';
                    if (!FINNHUB_API_KEY || FINNHUB_API_KEY.includes('PASTE')) { stockWidget.innerHTML = '<div class="stock-row"><span>NO API KEY</span></div>'; return; }
                    symbols.forEach(symbol => {
                        const row = document.createElement('div'); row.className = 'stock-row';
                        row.innerHTML = `<div class="stock-info"><i class="fa-solid"></i> ${symbol}</div><span class="stock-price">...</span>`;
                        stockWidget.appendChild(row);
                        fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`)
                            .then(r => r.json()).then(data => {
                                if (!data || typeof data.c === 'undefined') { row.querySelector('.stock-price').textContent = 'N/A'; return; }
                                const priceEl = row.querySelector('.stock-price'); const iconEl = row.querySelector('i');
                                priceEl.textContent = (data.c < 10) ? data.c.toFixed(3) : data.c.toFixed(2);
                                iconEl.className = 'fa-solid';
                                if (data.d > 0) iconEl.classList.add('fa-caret-up'); else if (data.d < 0) iconEl.classList.add('fa-caret-down');
                            });
                    });
                }
                stockWidget.addEventListener('dblclick', () => { stockSymbolsInput.value = getStockSymbols().join(', '); funModeCheckbox.checked = getFunModeState(); stockEditorMenu.classList.add('visible'); });
                const closeStockEditor = () => stockEditorMenu.classList.remove('visible');
                closeStockEditorBtn.addEventListener('click', closeStockEditor);
                stockEditorMenu.addEventListener('click', (e) => { if (e.target === stockEditorMenu) closeStockEditor(); });
                saveStocksBtn.addEventListener('click', () => { const newSymbols = stockSymbolsInput.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s.length > 0).slice(0, 7); saveStockSymbols(newSymbols); saveFunModeState(funModeCheckbox.checked); lastKnownFirstStockPrice = null; updateStockWidget(); closeStockEditor(); });

                (function setupBaseFeatures() {
                    const DRAGGABLE_ELEMENT_IDS = ['clock', 'youtube-music-btn', 'youtube-btn', 'stock-widget', 'settings-btn'];
                    const timeElems = { h: document.getElementById('hours'), m: document.getElementById('minutes'), d: document.getElementById('date') };
                    const weatherElems = { t: document.getElementById('temperature'), i: document.getElementById('weather-icon') };
                    const weatherLocationInput = document.getElementById('weather-location-input');
                    let clockScale = 1;
                    const getweatherLocation = () => localStorage.getItem('lockscreenWeatherLocation') || '';
                    const fetchWeather = () => {
                        const location = getweatherLocation();
                        weatherLocationInput.value = location;
                        const url = `https://wttr.in/${location || 'Trondheim'}?format=j1`;
                        const iM = { 'sunny': 'fa-sun', 'clear': 'fa-sun', 'partly cloudy': 'fa-cloud-sun', 'cloudy': 'fa-cloud', 'overcast': 'fa-cloud', 'mist': 'fa-smog', 'fog': 'fa-smog', 'patchy rain': 'fa-cloud-rain', 'rain': 'fa-cloud-showers-heavy', 'drizzle': 'fa-cloud-rain', 'patchy snow': 'fa-snowflake', 'snow': 'fa-snowflake', 'sleet': 'fa-cloud-meatball', 'ice pellets': 'fa-icicles', 'thunder': 'fa-cloud-bolt', 'blizzard': 'fa-wind' };
                        fetch(url).then(r => r.json()).then(d => { const c = d.current_condition[0]; weatherElems.t.textContent = `${c.temp_C}°C`; const ds = c.weatherDesc[0].value.toLowerCase(); let ic = 'fa-cloud-sun'; for (const k in iM) { if (ds.includes(k)) { ic = iM[k]; break; } } weatherElems.i.className = `fa-solid ${ic}`; }).catch(e => { weatherElems.t.textContent = 'N/A'; });
                    };
                    weatherLocationInput.addEventListener('change', () => { localStorage.setItem('lockscreenWeatherLocation', weatherLocationInput.value.trim()); fetchWeather(); });
                    const updateTime = () => { const n = new Date(); timeElems.h.textContent = String(n.getHours()).padStart(2, '0'); timeElems.m.textContent = String(n.getMinutes()).padStart(2, '0'); timeElems.d.textContent = n.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }); };
                    const applyClockScale = (scale) => { const baseSizeVW = 15; const newSize = baseSizeVW * scale; timeElems.h.style.fontSize = `clamp(${newSize * 0.4}rem, ${newSize}vw, ${newSize * 0.8}rem)`; timeElems.m.style.fontSize = `clamp(${newSize * 0.4}rem, ${newSize}vw, ${newSize * 0.8}rem)`; clockScale = scale; };
                    
                    const savePos = () => {
                        const p = {};
                        DRAGGABLE_ELEMENT_IDS.forEach(id => {
                            const e = document.getElementById(id);
                            if (e) {
                                const topPercent = (e.offsetTop / lockScreen.clientHeight) * 100;
                                const leftPercent = (e.offsetLeft / lockScreen.clientWidth) * 100;
                                p[id] = { t: `${topPercent}%`, l: `${leftPercent}%` };
                                if (id === 'clock') p[id].s = clockScale;
                            }
                        });
                        localStorage.setItem('lockscreenItemPositions_v2', JSON.stringify(p));
                    };
                    const loadPos = () => {
                        const p = JSON.parse(localStorage.getItem('lockscreenItemPositions_v2'));
                        if (p) {
                            Object.keys(p).forEach(id => {
                                const e = document.getElementById(id);
                                const pos = p[id];
                                if (e && pos.t && pos.l) {
                                    e.style.top = pos.t; e.style.left = pos.l;
                                    e.style.transform = 'none';
                                    if (id === 'clock' && pos.s) applyClockScale(pos.s);
                                }
                            });
                        }
                    };
                    
                    const repositionOffscreenElements = () => {
                        const screenRect = lockScreen.getBoundingClientRect();
                        let positionWasAdjusted = false;
                        DRAGGABLE_ELEMENT_IDS.forEach(id => {
                            const el = document.getElementById(id);
                            if (!el) return;
                            const elRect = el.getBoundingClientRect();
                            if (elRect.right > screenRect.right) { el.style.left = `${screenRect.width - elRect.width}px`; positionWasAdjusted = true; }
                            if (elRect.bottom > screenRect.bottom) { el.style.top = `${screenRect.height - elRect.height}px`; positionWasAdjusted = true; }
                            if (elRect.left < screenRect.left) { el.style.left = '0px'; positionWasAdjusted = true; }
                            if (elRect.top < screenRect.top) { el.style.top = '0px'; positionWasAdjusted = true; }
                        });
                        if (positionWasAdjusted) { savePos(); }
                    };
                    window.addEventListener('resize', repositionOffscreenElements);

                    const makeDraggable = (el) => { let oX, oY, isD, hasMoved; let isPinching = false, initialPinchDist = 0, initialScale = 1; const getDist = (t) => Math.hypot(t[0].clientX - t[1].clientX, t[0].clientY - t[1].clientY); const mv = (e) => { if (el.id === 'clock' && isPinching && e.touches && e.touches.length === 2) { e.preventDefault(); const oldWidth = el.offsetWidth, oldHeight = el.offsetHeight, oldLeft = el.offsetLeft, oldTop = el.offsetTop; const newDist = getDist(e.touches); const scaleRatio = newDist / initialPinchDist; const newScale = Math.max(0.5, Math.min(initialScale * scaleRatio, 3)); applyClockScale(newScale); const newWidth = el.offsetWidth, newHeight = el.offsetHeight; const deltaWidth = newWidth - oldWidth, deltaHeight = newHeight - oldHeight; el.style.left = `${oldLeft - (deltaWidth / 2)}px`; el.style.top = `${oldTop - (deltaHeight / 2)}px`; return; } if (!isD) return; e.preventDefault(); hasMoved = true; const cX = e.touches ? e.touches[0].clientX : e.clientX, cY = e.touches ? e.touches[0].clientY : e.clientY; let nX = cX - oX, nY = cY - oY; const sR = lockScreen.getBoundingClientRect(), eR = el.getBoundingClientRect(); nX = Math.max(0, Math.min(nX, sR.width - eR.width)); nY = Math.max(0, Math.min(nY, sR.height - eR.height)); el.style.left = `${nX}px`; el.style.top = `${nY}px`; el.style.transform = 'none'; }; const sD = (e) => { if (e.touches && e.touches.length === 2 && el.id === 'clock') { isPinching = true; isD = false; initialPinchDist = getDist(e.touches); initialScale = clockScale; return; } isD = true; hasMoved = false; const cX = e.touches ? e.touches[0].clientX : e.clientX, cY = e.touches ? e.touches[0].clientY : e.clientY; oX = cX - el.offsetLeft; oY = cY - el.offsetTop; document.addEventListener('mousemove', mv, { passive: false }); document.addEventListener('touchmove', mv, { passive: false }); document.addEventListener('mouseup', stD); document.addEventListener('touchend', stD); }; const stD = () => { if (!isD && !isPinching) return; isD = false; isPinching = false; savePos(); document.removeEventListener('mousemove', mv); document.removeEventListener('touchmove', mv); document.removeEventListener('mouseup', stD); document.removeEventListener('touchend', stD); }; el.addEventListener('mousedown', sD); el.addEventListener('touchstart', sD, { passive: false }); const lnk = el.querySelector('a'); if (lnk) { lnk.addEventListener('click', (e) => { if (hasMoved) e.preventDefault(); }); } if(el.id === 'settings-btn') { el.addEventListener('click', (e) => { if (!hasMoved) { showWallpaperSettings(); settingsMenu.classList.add('visible'); } }); } };
                    
                    setInterval(updateTime, 1000); updateTime();
                    DRAGGABLE_ELEMENT_IDS.forEach(id => { const el = document.getElementById(id); if (el) makeDraggable(el); });
                    
                    loadPos();
                    fetchWeather(); setInterval(fetchWeather, 30 * 60 * 1000);
                    updateStockWidget(); setInterval(updateStockWidget, 60000);
                    checkFunModeTrigger(); setInterval(checkFunModeTrigger, 60 * 1000);
                })();
                
                const getWps = () => JSON.parse(localStorage.getItem('lockscreenWallpapers_v2')) || [initialWallpaper];
                const saveWps = (wps) => localStorage.setItem('lockscreenWallpapers_v2', JSON.stringify(wps));
                const setWp = (wpObj) => { exitPanningMode(); lockScreen.style.backgroundImage = `url('${wpObj.url}')`; lockScreen.style.backgroundPosition = wpObj.position || 'center center'; currentWallpaperImg.src = wpObj.url; };
                const renderWpChoices = () => { const cont = document.getElementById('wallpaper-choices'); cont.innerHTML = ''; getWps().forEach(wp => { const thumb = document.createElement('div'); thumb.className = 'wallpaper-thumbnail'; thumb.style.backgroundImage = `url('${wp.url}')`; const rmvBtn = document.createElement('span'); rmvBtn.className = 'remove-thumb-btn'; rmvBtn.innerHTML = '×'; rmvBtn.title = 'Remove wallpaper'; rmvBtn.addEventListener('click', (e) => { e.stopPropagation(); const newWps = getWps().filter(w => w.url !== wp.url); saveWps(newWps); renderWpChoices(); }); thumb.appendChild(rmvBtn); thumb.addEventListener('click', () => { setWp(wp); localStorage.setItem('lockscreenLastSelectedWp', wp.url); settingsMenu.classList.remove('visible'); }); cont.appendChild(thumb); }); };
                document.getElementById('wallpaper-url-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { const url = e.target.value.trim(); if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { const wps = getWps(); if (!wps.some(w => w.url === url)) { const newWp = { url: url, position: 'center center' }; wps.push(newWp); saveWps(wps); setWp(newWp); localStorage.setItem('lockscreenLastSelectedWp', newWp.url); renderWpChoices(); } e.target.value = ''; settingsMenu.classList.remove('visible'); } else { alert('Invalid URL.'); } } });
                function exitPanningMode() { if (!isPanningMode) return; isPanningMode = false; lockScreen.classList.remove('panning-active'); const url = currentWallpaperImg.src; const wps = getWps(); const idx = wps.findIndex(w => w.url === url); if (idx > -1) { wps[idx].position = lockScreen.style.backgroundPosition; saveWps(wps); } }

                const resetInactivityPrompts = () => {
                    clearTimeout(inactivityTimer);
                    unlockPrompt.classList.remove('visible');
                    fullscreenHint.classList.remove('visible');
                    inactivityTimer = setTimeout(() => {
                        if (document.fullscreenElement) {
                            unlockPrompt.classList.add('visible');
                        } else {
                            fullscreenHint.classList.add('visible');
                        }
                    }, 60000);
                };
                ['mousemove', 'mousedown', 'keydown'].forEach(evt => document.addEventListener(evt, resetInactivityPrompts));
                resetInactivityPrompts();
                unlockPrompt.addEventListener('click', () => { if (document.fullscreenElement) document.exitFullscreen(); });
                
                lockScreen.addEventListener('click', (e) => {
                    if (e.target.closest('.draggable-item') || e.target === unlockPrompt || hasMovedWp) return;
                    if (isPanningMode) { exitPanningMode(); return; }
                    if (document.fullscreenElement) { clearTimeout(clickTimer); clickTimer = setTimeout(() => { document.exitFullscreen(); }, 250); }
                });
                lockScreen.addEventListener('dblclick', (e) => {
                    clearTimeout(clickTimer); clearTimeout(pressHoldTimer);
                    if (e.target.closest('.draggable-item')) return;
                    if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen();
                });
                
                let isDraggingWp = false, sPanX, sPanY, sBgX, sBgY;
                const panMove = (e) => { if (!isDraggingWp) return; hasMovedWp = true; e.preventDefault(); const cX = e.touches ? e.touches[0].clientX : e.clientX; const cY = e.touches ? e.touches[0].clientY : e.clientY; const dX = cX - sPanX, dY = cY - sPanY; let nBgX = sBgX + dX, nBgY = sBgY + dY; const sW = lockScreen.clientWidth, sH = lockScreen.clientHeight; const iW = currentWallpaperImg.naturalWidth, iH = currentWallpaperImg.naturalHeight; const sR = sW / sH, iR = iW / iH; let scW, scH; if (iR > sR) { scH = sH; scW = sH * iR; } else { scW = sW; scH = sW / iR; } const minX = sW - scW, minY = sH - scH; nBgX = Math.max(minX, Math.min(0, nBgX)); nBgY = Math.max(minY, Math.min(0, nBgY)); lockScreen.style.backgroundPosition = `${nBgX}px ${nBgY}px`; };
                const interactionEnd = () => { clearTimeout(pressHoldTimer); if (isPanningMode) { isDraggingWp = false; document.removeEventListener('mousemove', panMove); document.removeEventListener('touchmove', panMove); } document.removeEventListener('mouseup', interactionEnd); document.removeEventListener('touchend', interactionEnd); document.removeEventListener('mousemove', clearHoldTimer); };
                const clearHoldTimer = () => { clearTimeout(pressHoldTimer); };
                const interactionStart = (e) => {
                    if (e.target.closest('.draggable-item')) return;
                    
                    const sW = lockScreen.clientWidth, sH = lockScreen.clientHeight, iW = currentWallpaperImg.naturalWidth, iH = currentWallpaperImg.naturalHeight;
                    if (iW <= sW && iH <= sH && !isPanningMode) return;

                    hasMovedWp = false;
                    document.addEventListener('mouseup', interactionEnd);
                    document.addEventListener('touchend', interactionEnd);

                    clearTimeout(pressHoldTimer);
                    pressHoldTimer = setTimeout(() => {
                       isPanningMode = true; isDraggingWp = true;
                       lockScreen.classList.add('panning-active');
                       const bgPos = window.getComputedStyle(lockScreen).backgroundPosition.split(' ');
                       sBgX = parseFloat(bgPos[0]); sBgY = parseFloat(bgPos[1]);
                       sPanX = e.touches ? e.touches[0].clientX : e.clientX; sPanY = e.touches ? e.touches[0].clientY : e.clientY;
                       document.addEventListener('mousemove', panMove);
                       document.addEventListener('touchmove', panMove);
                    }, 500);

                    document.addEventListener('mousemove', clearHoldTimer, { once: true });
                };
                lockScreen.addEventListener('mousedown', interactionStart);
                lockScreen.addEventListener('touchstart', interactionStart, { passive: false });
                
                const themeToggle = document.getElementById('theme-toggle');
                const clockColorInput = document.getElementById('clock-color-input');
                const fontSelect = document.getElementById('font-select');
                const resetPositionsBtn = document.getElementById('reset-positions-btn');

                const applyTheme = (theme) => lockScreen.classList.toggle('light-theme', theme === 'light');
                const applyClockColor = (color) => clock.style.color = color;
                const applyFont = (font) => clock.style.fontFamily = font;

                const savedTheme = localStorage.getItem('lockscreenTheme') || 'dark';
                themeToggle.checked = savedTheme === 'light';
                applyTheme(savedTheme);
                
                const savedColor = localStorage.getItem('lockscreenClockColor') || '#ffffff';
                clockColorInput.value = savedColor;
                applyClockColor(savedColor);

                const savedFont = localStorage.getItem('lockscreenClockFont') || "'Oswald', sans-serif";
                fontSelect.value = savedFont;
                applyFont(savedFont);

                themeToggle.addEventListener('change', () => { const newTheme = themeToggle.checked ? 'light' : 'dark'; localStorage.setItem('lockscreenTheme', newTheme); applyTheme(newTheme); });
                clockColorInput.addEventListener('input', () => { const newColor = clockColorInput.value; localStorage.setItem('lockscreenClockColor', newColor); applyClockColor(newColor); });
                fontSelect.addEventListener('change', () => { const newFont = fontSelect.value; localStorage.setItem('lockscreenClockFont', newFont); applyFont(newFont); });

                resetPositionsBtn.addEventListener('click', () => {
                    localStorage.removeItem('lockscreenItemPositions_v2');
                    ['clock', 'youtube-music-btn', 'youtube-btn', 'stock-widget', 'settings-btn'].forEach(id => {
                        document.getElementById(id).style.cssText = '';
                    });
                    const applyClockScale = (scale) => { clockScale = scale; const baseSizeVW = 15; const newSize = baseSizeVW * scale; document.getElementById('hours').style.fontSize = `clamp(${newSize * 0.4}rem, ${newSize}vw, ${newSize * 0.8}rem)`; document.getElementById('minutes').style.fontSize = `clamp(${newSize * 0.4}rem, ${newSize}vw, ${newSize * 0.8}rem)`; };
                    applyClockScale(1);
                    settingsMenu.classList.remove('visible');
                });

                document.getElementById('qr-upload-btn').addEventListener('click', () => { if (pollingInterval) clearInterval(pollingInterval); const session = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`; const uploadUrl = `${window.location.href.split('?')[0]}?upload=true&session=${session}`; const qrCodeContainer = document.getElementById('qr-code'); qrCodeContainer.innerHTML = ''; qrModal.style.display = 'flex'; new QRCode(qrCodeContainer, { text: uploadUrl, width: 200, height: 200 }); startPolling(session); });
                qrModal.addEventListener('click', (e) => { if (e.target === qrModal) { qrModal.style.display = 'none'; clearInterval(pollingInterval); } });
                function startPolling(session) { if(pollingInterval) clearInterval(pollingInterval); pollingInterval = setInterval(() => { fetch(`https://api.npoint.io/${NPOINT_BIN_ID}`, { cache: 'no-cache' }).then(r => r.json()).then(data => { if (data && data[session]) { clearInterval(pollingInterval); pollingInterval = null; qrModal.style.display = 'none'; const newWp = { url: data[session], position: 'center center' }; const wps = getWps(); if (!wps.some(w => w.url === newWp.url)) { wps.push(newWp); saveWps(wps); } setWp(newWp); localStorage.setItem('lockscreenLastSelectedWp', newWp.url); renderWpChoices(); } }).catch(err => { console.log("Polling... waiting for data."); }); }, 2500); }
                
                renderWpChoices();
                const allWps = getWps();
                const lastSelectedUrl = localStorage.getItem('lockscreenLastSelectedWp');
                let wpToLoad = allWps.find(w => w.url === lastSelectedUrl);
                if (!wpToLoad) {
                    wpToLoad = allWps[0] || initialWallpaper;
                }
                setWp(wpToLoad);


                document.addEventListener('keydown', (e) => {
                    if (!getFunModeState()) return;
                    if (e.key === 'ArrowUp') { e.preventDefault(); console.log("Simulating stock GAIN with ArrowUp."); triggerScreenFlash(true); triggerIconShower(true); }
                    else if (e.key === 'ArrowDown') { e.preventDefault(); console.log("Simulating stock LOSS with ArrowDown."); triggerScreenFlash(false); triggerIconShower(false); }
                });
            }
        });
    </script>
</body>
</html>
